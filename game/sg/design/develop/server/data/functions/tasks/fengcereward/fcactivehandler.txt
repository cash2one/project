--#include "fcactivefunc.txt" once

--等级礼包
FCActivityHandler[1] = function ( sysarg, dp)
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > #st.fcreward.levelupreward then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if st.fcreward.levelupreward[index] ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
			return
		end

		st.fcreward.levelupreward[index] = 2
		LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.uplevelReward[index], 1, true, "fcactivity", "levelupreward")
		LActor.recharge(sysarg, FCActivityConf.uplevelReward[index])
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 1)
	if pack == nil then return end
	local count = #st.fcreward.levelupreward
	DataPack.writeInt(pack, count)
	for i = 1, count do
		DataPack.writeInt(pack, FCActivityConf.uplevel[i])
		DataPack.writeInt(pack, st.fcreward.levelupreward[i])
	end
	DataPack.flush(pack)
end

-- 每日登录成长基金
FCActivityHandler[2] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > #st.fcreward.dailyreward then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if st.fcreward.dailyreward[index] ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
			return
		end

		st.fcreward.dailyreward[index] = 2
		LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.dailyReward[index], 1, true, "fcactivity", "fcdailyreward")
		LActor.recharge(sysarg, FCActivityConf.dailyReward[index])
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 2)
	if pack == nil then return end
	local count = #st.fcreward.dailyreward
	DataPack.writeInt(pack, count)
	for i = 1, count do
		DataPack.writeInt(pack, i)
		DataPack.writeInt(pack, st.fcreward.dailyreward[i])
	end
	DataPack.flush(pack)
end

-- 每日时段领取
FCActivityHandler[3] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > 2 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if index == 1 then
			if st.fcreward.onlinereward1 ~= 1 then
				LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
				return
			end

			st.fcreward.onlinereward1 = 2
			LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.onlineRewardTime[1].award, 1, true, "fcactivity", "fconlinereward")
			LActor.recharge(sysarg, FCActivityConf.onlineRewardTime[1].award)
		else
			if st.fcreward.onlinereward2 ~= 1 then
				LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
				return
			end

			st.fcreward.onlinereward2 = 2
			LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.onlineRewardTime[2].award, 1, true, "fcactivity", "fconlinereward")
			LActor.recharge(sysarg, FCActivityConf.onlineRewardTime[2].award)
		end
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 3)
	if pack == nil then return end
	DataPack.writeInt(pack, st.fcreward.onlinereward1)
	DataPack.writeInt(pack, st.fcreward.onlinereward2)
	DataPack.flush(pack)
end

-- 活跃度奖励
FCActivityHandler[4] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > #st.fcreward.activityaward then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if st.fcreward.activityaward[index] ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
			return
		end

		st.fcreward.activityaward[index] = 2
		LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.activityReward[index], 1, true, "fcactivity", "fcactivityreward")
		LActor.recharge(sysarg, FCActivityConf.activityReward[index])
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 4)
	if pack == nil then return end
	local count = #st.fcreward.activityaward
	DataPack.writeInt(pack, count)
	for i = 1, count do
		DataPack.writeInt(pack, FCActivityConf.activity[i])
		DataPack.writeInt(pack, st.fcreward.activityaward[i])
	end
	DataPack.flush(pack)
end

-- 在线时长
FCActivityHandler[5] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > #st.fcreward.keeploginaward then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if st.fcreward.keeploginaward[index] ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
			return
		end

		st.fcreward.keeploginaward[index] = 2
		LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.keeptimeaward[index], 1, true, "fcactivity", "fckeeptimereward")
		LActor.recharge(sysarg, FCActivityConf.keeptimeaward[index])
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 5)
	if pack == nil then return end
	local count = #st.fcreward.keeploginaward
	local keeptime = LActor.getOnlineTimePerDay(sysarg)
	DataPack.writeInt(pack, keeptime)
	DataPack.writeInt(pack, count)
	for i = 1, count do
		DataPack.writeInt(pack, FCActivityConf.keeptime[i])
		DataPack.writeInt(pack, st.fcreward.keeploginaward[i])
	end
	DataPack.flush(pack)
end

-- 修仙初成
FCActivityHandler[7] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	if st.fcreward.juniorEffort == nil then
		st.fcreward.juniorEffort = {}
		for i=1,#FCActivityConf.JuniorEffort do
			st.fcreward.juniorEffort[i] = 0
		end
	end

	local level = LActor.getLevel(sysarg)
	if level > 0 and level >= FCActivityConf.JuniorEffort[1].condition and st.fcreward.juniorEffort[1] == 0 then
		st.fcreward.juniorEffort[1] = 1
	end
	local fight = LActor.getActorFightCapacity(sysarg)
	if fight > 0 and fight >= FCActivityConf.JuniorEffort[2].condition and st.fcreward.juniorEffort[2] == 0 then
		st.fcreward.juniorEffort[2] = 1
	end
	local petfight = LActor.getPetFightCapacity(sysarg)
	if petfight > 0 and petfight >= FCActivityConf.JuniorEffort[3].condition and st.fcreward.juniorEffort[3] == 0 then
		st.fcreward.juniorEffort[3] = 1
	end
	local mountfight = LActor.getMountFightCapacity(sysarg)
	if mountfight > 0 and mountfight >= FCActivityConf.JuniorEffort[4].condition and st.fcreward.juniorEffort[4] == 0 then
		st.fcreward.juniorEffort[4] = 1
	end
	--[[
	local wingfight = LActor.getWingFightCapacity(sysarg)
	if wingfight > 0 and wingfight >= FCActivityConf.JuniorEffort[5].condition and st.fcreward.juniorEffort[5] == 0 then
		st.fcreward.juniorEffort[5] = 1
	end
	]]
	if st.achieveScore == nil then
		st.achieveScore = 0
	end
	if st.achieveScore > 0 and st.achieveScore >= FCActivityConf.JuniorEffort[7].condition and st.fcreward.juniorEffort[7] == 0 then
		st.fcreward.juniorEffort[7] = 1
	end
	local root, level = LActor.getRootData(sysarg)
	if st.fcreward.juniorEffort[8] == 0 and (root > math.floor(FCActivityConf.JuniorEffort[8].condition/100) or (root == math.floor(FCActivityConf.JuniorEffort[8].condition/100) and level >= math.fmod(FCActivityConf.JuniorEffort[8].condition, 100) ) ) then
		st.fcreward.juniorEffort[8] = 1
	end
	local crossLevel = LActor.GetCrossStarCount(sysarg)
	if crossLevel > 0 and crossLevel >= FCActivityConf.JuniorEffort[9].condition and st.fcreward.juniorEffort[9] == 0 then
		st.fcreward.juniorEffort[9] = 1
	end
	local fightRank = FightFun.getRanking(sysarg)
	if fightRank >= 0 and fightRank <= FCActivityConf.JuniorEffort[10].condition and st.fcreward.juniorEffort[10] == 0 then
		st.fcreward.juniorEffort[10] = 1
	end
	FCActivityHandler.sendJuniorEffort(sysarg)
end

-- 修仙初成
FCActivityHandler[8] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

	local index = DataPack.readInt(dp)
	if index < 1 or index > #FCActivityConf.JuniorEffort then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	if st.fcreward.juniorEffort == nil then
		st.fcreward.juniorEffort = {}
		for i=1,#FCActivityConf.JuniorEffort do
			st.fcreward.juniorEffort[i] = 0
		end
	end

	if st.fcreward.juniorEffort[index] > 1 then
		LActor.sendTipmsg( sysarg, Lang.ScriptTips.xxcc002, ttMessage )
		return
	end

	if st.fcreward.juniorEffort[index] < 1 then
		LActor.sendTipmsg( sysarg, Lang.ScriptTips.xxcc003, ttMessage )
		return
	end

	LActor.changeMoney(sysarg, mtYuanbao, FCActivityConf.JuniorEffort[index].gold, 1, true, "fcactivity", "fcjunioreffortaward")
	LActor.recharge(sysarg, FCActivityConf.JuniorEffort[index].gold)

	st.fcreward.juniorEffort[index]  = 2	

	FCActivityHandler.sendJuniorEffort(sysarg)		
end

-- 媒体礼包
FCActivityHandler[9] = function ( sysarg, dp )
	if FCActivityHandler.IsOpen() == 0 then return end

 	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		if st.fcreward.meitilibao ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc002, ttMessage)
			return
		end

		if LActor.addItem(sysarg, 44423, 0, 0, 1, 1, "fcactivity", 1) >= 1 then
			-- 播放特效
		   	local effects = {}
			local effect = {}
			effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
		    effect.id = 44423
		    effect.count = 1
		    effects[#effects+1] = effect
			if #effects > 0 then
				MiscFunc.PlayItemEffect(sysarg, 1, effects)
			end
			--设置已领
			st.fcreward.meitilibao = 2
		else
			--背包已满
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc004, ttMessage)
		end
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 9)
	if pack == nil then return end
	DataPack.writeInt(pack, st.fcreward.meitilibao)
	DataPack.flush(pack)
end

-- 7日留存礼包信息
FCActivityHandler.sendSeveAwardInfo = function (sysarg)
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end

	if st.SevenInfo == nil then
		st.SevenInfo = {}
		st.SevenInfo.firsttick = System.getToday()
		st.SevenInfo.lastdays = 0
 		st.SevenInfo.seveninfo = {}
 		for i = 1, #FCActivityConf.SevenAward do
 			st.SevenInfo.seveninfo[i] = 0
 		end
	end

 	for i=1,st.SevenInfo.lastdays do
 		if st.SevenInfo.seveninfo[i] == 0 then
 			st.SevenInfo.seveninfo[i] = 1
 		end
 	end

	local left = st.SevenInfo.firsttick + 7*24*3600 - System.getCurrMiniTime()
	if left < 0 then
		left = 0
	end
	
	local npack = DataPack.allocPacket(sysarg, 200, 10)
	if npack == nil then return end
	if left < 0 then
		left = 0
	end
	DataPack.writeInt(npack, left)
	local count = #st.SevenInfo.seveninfo
	DataPack.writeInt(npack, count)
	for i=1,count do
		DataPack.writeInt(npack, i)
		DataPack.writeInt(npack, st.SevenInfo.seveninfo[i])
	end
	DataPack.flush(npack)
end

FCActivityHandler.sendSeveAwardNewDay = function (sysarg)
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end

	if st.SevenInfo == nil then
		st.SevenInfo = {}
		st.SevenInfo.firsttick = System.getToday()
		st.SevenInfo.lastdays = 0
 		st.SevenInfo.seveninfo = {}
 		 for i = 1, #FCActivityConf.SevenAward do
 			st.SevenInfo.seveninfo[i] = 0
 		end
	end

	st.SevenInfo.lastdays = st.SevenInfo.lastdays + 1

	FCActivityHandler.sendSeveAwardInfo(sysarg)
end

-- 7日留存礼包
FCActivityHandler[10] = function ( sysarg, dp )
 	local st = LActor.getStaticVar(sysarg)
 	if st == nil then return end

	if st.SevenInfo == nil then
		st.SevenInfo = {}
		st.SevenInfo.firsttick = System.getToday()
		st.SevenInfo.lastdays = 0
 		st.SevenInfo.seveninfo = {}
 		for i = 1, #FCActivityConf.SevenAward do
 			st.SevenInfo.seveninfo[i] = 0
 		end
	end

	local ty = DataPack.readInt(dp)
	if ty == 1 then
		local index = DataPack.readInt(dp)
		if index < 1 or index > #st.SevenInfo.seveninfo then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc001, ttMessage)
			return
		end

		if st.SevenInfo.seveninfo[index] ~= 1 then
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc003, ttMessage)
			return
		end

		if LActor.addItem(sysarg, FCActivityConf.SevenAward[index], 0, 0, 1, 1, "SevenAward", 1) >= 1 then
			-- 播放特效
		   	local effects = {}
			local effect = {}
			effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
		    effect.id = FCActivityConf.SevenAward[index]
		    effect.count = 1
		    effects[#effects+1] = effect
			if #effects > 0 then
				MiscFunc.PlayItemEffect(sysarg, 1, effects)
			end
			--设置已领
			st.SevenInfo.seveninfo[index] = 2
		else
			--背包已满
			LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc004, ttMessage)
		end
	end		

	local pack = DataPack.allocPacket(sysarg, 200, 10)
	if pack == nil then return end
	local left = st.SevenInfo.firsttick + 7*24*3600 - System.getCurrMiniTime()
	if left < 0 then
		left = 0
	end
	DataPack.writeInt(pack, left)
	local count = #st.SevenInfo.seveninfo
	DataPack.writeInt(pack, count)
	for i = 1, count do
		DataPack.writeInt(pack, i)
		DataPack.writeInt(pack, st.SevenInfo.seveninfo[i])
	end
	DataPack.flush(pack)
end


--登录好礼活动开启和关闭  for wupeng add 2013-10-28 begin
FCActivityHandler.sendLoginAwardInfo = function (sysarg)
    local  nooff = FCActivityHandler.sendnooffInfo()

    local pack = DataPack.allocPacket(sysarg, 200, 11)
    if pack == nil then return end
	DataPack.writeInt(pack, nooff)
	DataPack.flush(pack)
end

FCActivityHandler.sendnooffInfo = function()
    local day = System.getOpenServerDay()
    local nooff = 0
    --开服第二周开启活动
    if day >= 8 and day <= 14 then
    	nooff = 1
    end
    return nooff
end    
--登录好礼活动开启和关闭  for wupeng add 2013-10-28 end

--获取每天的登录好礼剩余次数 for wupeng add 2013-10-28 begin
FCActivityHandler[12] = function ( sysarg, dp )
    local  nooff = FCActivityHandler.sendnooffInfo()
    if nooff ~= 1 then return end
    local st = LActor.getStaticVar(sysarg)
    if st == nil then return end
    if st.EveDayInfo == nil then
	    st.EveDayInfo = {}
	    st.EveDayInfo.countnumber = 0
	    st.EveDayInfo.zongci = 0
	    st.EveDayInfo.number = 0
	    st.EveDayInfo.LActornumber = 0	
	    st.EveDayInfo.time = System.getToday()	
	    st.EveDayInfo.fapai = {} 
	    st.EveDayInfo.biaoshi = {}
	    for i = 1,9 do
           st.EveDayInfo.fapai[i] = 0
           st.EveDayInfo.biaoshi[i] = 0
	    end                                                   	   
	end 
    local pack = DataPack.allocPacket(sysarg, 200, 12)
    if pack == nil then return end
    DataPack.writeInt(pack, st.EveDayInfo.LActornumber)
    DataPack.writeInt(pack, st.EveDayInfo.countnumber)
    DataPack.writeInt(pack, st.EveDayInfo.zongci)
    DataPack.flush(pack)
end
--获取每天的登录好礼剩余次数 for wupeng add 2013-10-28 end

--登录好礼翻牌获取奖励 for wupeng add 2013-10-28 begin
FCActivityHandler[13] = function ( sysarg, dp )
    local  nooff = FCActivityHandler.sendnooffInfo()
    if nooff ~= 1 then return end
    local ty = DataPack.readInt(dp)
    if ty == nil then
    	LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc008, ttMessage)
		return
    end
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	if st.EveDayInfo == nil then
	    st.EveDayInfo = {}
	    st.EveDayInfo.countnumber = 0
	    st.EveDayInfo.zongci = 0
	    st.EveDayInfo.number = 0
	    st.EveDayInfo.LActornumber = 0	
	    st.EveDayInfo.time = System.getToday()	
	    st.EveDayInfo.fapai = {} 
	    st.EveDayInfo.biaoshi = {}
	    for i = 1,9 do
           st.EveDayInfo.fapai[i] = 0
           st.EveDayInfo.biaoshi[i] = 0
	    end                                                   	   
	end
    if st.EveDayInfo.LActornumber == 0 then
    	LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc003, ttMessage)
    	return
    end
    if Item.getBagEmptyGridCount(sysarg) < 1 then
		LActor.sendTipmsg(sysarg, Lang.PetLang.p33, ttMessage)
		return
	end
	local itemid = st.EveDayInfo.fapai[ty]
    local count = 0
    --查找被抽到物品的个数 begin
	for y = 1 ,#FCActivityConf.ABAward.AAwardPos do
		if FCActivityConf.ABAward.AAwardPos[y].itemid == itemid then
		   count = FCActivityConf.ABAward.AAwardPos[y].count
		   break
		end
	end
     
    if count == 0 then
    	for z = 1, #FCActivityConf.ABAward.BAwardPos do
    		if FCActivityConf.ABAward.BAwardPos[z].itemid == itemid then
    		   count = FCActivityConf.ABAward.BAwardPos[z].count
    		   break 
    		end
    	end
    end
    --查找被抽到物品的个数 end

    st.EveDayInfo.LActornumber = st.EveDayInfo.LActornumber - 1
    LActor.addItem(sysarg, itemid, 0,0,count,1, "fapai_AwardInfo", 1)
    --是否需要广播 可能不符合需求 begin
    local broadlist = FCActivityConf.AAwardBroadcastData[itemid]
	if broadlist then
		local char_name = LActor.getName(sysarg)
       	if char_name == nil then
       	char_name = " "
       	end

       	local item_name = Item.getColorName(itemid)
       	if item_name == nil then
            item_name = " "
       	end
       local annostr = string.format(Lang.ScriptTips.fc005, char_name, item_name)
       -- System.broadcastTipmsg(annostr, ttHearsay)
       annostr = string.format(Lang.ScriptTips.fc005, char_name, item_name)
       --System.broadcastTipmsg(annostr, ttGmTip)
	end
	--是否需要广播 可能不符合需求 begin
	for f = 1 ,9 do
    	if itemid == st.EveDayInfo.fapai[f] then
    		st.EveDayInfo.biaoshi[f] = 1
    		break
    	end
    end

    local pack = DataPack.allocPacket(sysarg, 200, 13)
    if pack == nil then return end
    DataPack.writeInt(pack, itemid)
    DataPack.flush(pack)
end
--登录好礼翻牌获取奖励 for wupeng add 2013-10-28 end

--打乱牌 begin
FCActivityHandler[21] = function (sysarg)
    local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	if st.EveDayInfo == nil then
	    st.EveDayInfo = {}
	    st.EveDayInfo.countnumber = 0
	    st.EveDayInfo.zongci = 0
	    st.EveDayInfo.number = 0
	    st.EveDayInfo.LActornumber = 0	
	    st.EveDayInfo.time = System.getToday()	
	    st.EveDayInfo.fapai = {} 
	    st.EveDayInfo.biaoshi = {}
	    for i = 1,9 do
           st.EveDayInfo.fapai[i] = 0
           st.EveDayInfo.biaoshi[i] = 0
	    end                                                   	   
	end
	--打乱牌
	local   Awarddaluan = 0
	local   randxiabiao1 = 0
	local   randxiaobiao2 = 0

	for i = 1,9 do
		randxiabiao1 = System.getRandomNumber(9)+1
	    randxiaobiao2 = System.getRandomNumber(9)+1
	    Awarddaluan = st.EveDayInfo.fapai[randxiabiao1]
	    st.EveDayInfo.fapai[randxiabiao1] = st.EveDayInfo.fapai[randxiaobiao2]
	    st.EveDayInfo.fapai[randxiaobiao2] = Awarddaluan
	end 
	
	local pack = DataPack.allocPacket(sysarg, 200, 21)
    if pack == nil then return end
    DataPack.writeInt(pack,9)
    for i = 1,9 do
       DataPack.writeInt(pack, st.EveDayInfo.fapai[i])
       DataPack.writeInt(pack, st.EveDayInfo.biaoshi[i])
    end  
    DataPack.flush(pack) 
end
--打乱牌 end

--获取登录好礼的牌 for wupeng add 2013-10-29 begin
FCActivityHandler[14] = function ( sysarg, dp )
    local  nooff = FCActivityHandler.sendnooffInfo()
    if nooff ~= 1 then return end
    local st = LActor.getStaticVar(sysarg)
    if st == nil then return end
    if st.EveDayInfo == nil then
	    st.EveDayInfo = {}
	    st.EveDayInfo.countnumber = 0
	    st.EveDayInfo.zongci = 0
	    st.EveDayInfo.number = 0
	    st.EveDayInfo.LActornumber = 0	
	    st.EveDayInfo.time = System.getToday()	
	    st.EveDayInfo.fapai = {} 
	    st.EveDayInfo.biaoshi = {}
	    for i = 1,9 do
           st.EveDayInfo.fapai[i] = 0
           st.EveDayInfo.biaoshi[i] = 0
	    end                                                   	   
	end 
    local pack = DataPack.allocPacket(sysarg, 200, 14)
    if pack == nil then return end
    DataPack.writeInt(pack,9)
    for i = 1,9 do
       DataPack.writeInt(pack, st.EveDayInfo.fapai[i])
       DataPack.writeInt(pack, st.EveDayInfo.biaoshi[i])
    end    

    DataPack.flush(pack)
end
--获取登录好礼的牌 for wupeng add 2013-10-29 end

--获取登录好礼累计登录的奖励 for wupeng add 2013-10-29 begin
FCActivityHandler[15] = function (sysarg, dp)
     local  nooff = FCActivityHandler.sendnooffInfo()
     if nooff ~= 1 then return end
     local st = LActor.getStaticVar(sysarg)
     if st == nil then return end
     if st.EveDayInfo == nil then
	    st.EveDayInfo = {}
	    st.EveDayInfo.countnumber = 0
	    st.EveDayInfo.zongci = 0
	    st.EveDayInfo.number = 0
	    st.EveDayInfo.LActornumber = 0	
	    st.EveDayInfo.time = System.getToday()	
	    st.EveDayInfo.fapai = {} 
	    st.EveDayInfo.biaoshi = {}
	    for i = 1,9 do
           st.EveDayInfo.fapai[i] = 0
           st.EveDayInfo.biaoshi[i] = 0
	    end                                                   	   
	end 
     if st.dengluhaoliInfo == nil then
	    st.dengluhaoliInfo  = {}
	    st.dengluhaoliInfo.twoday = 0
	    st.dengluhaoliInfo.five = 0
	    st.dengluhaoliInfo.seven = 0
	end

    --根据玩家登录次数设置第几天的奖励为可以领取状态 for wupeng 2013-10-30 end
	--好礼状态
	local  haolistatu = 0
	--用户操作类型，ty：0表示查看，1表示领取
    local ty = DataPack.readInt(dp)
    if ty == nil then
    	LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc008, ttMessage)
		return
    end
    if ty == 1 then
	  if st.dengluhaoliInfo.twoday == 1 then
	  	 if Item.getBagEmptyGridCount(sysarg) < 1 then
		    LActor.sendTipmsg(sysarg, Lang.PetLang.p33, ttMessage)
		    return
	     end
	     LActor.addItem(sysarg, FCActivityConf.denglulibao[1], 0,0,1,1, "dengluhaolitwoday_AwardInfo", 1)
	     -- 播放特效
		 local effects = {}
		 local effect = {}
		 effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
		 effect.id = FCActivityConf.denglulibao[1]
		 effect.count = 1
		 effects[#effects+1] = effect
		 if #effects > 0 then
			MiscFunc.PlayItemEffect(sysarg, 1, effects)
		 end
         st.dengluhaoliInfo.twoday = 2
	  elseif st.dengluhaoliInfo.five == 1 then
	     if Item.getBagEmptyGridCount(sysarg) < 1 then
		    LActor.sendTipmsg(sysarg, Lang.PetLang.p33, ttMessage)
		    return
	     end
	     LActor.addItem(sysarg, FCActivityConf.denglulibao[2], 0,0,1,1, "dengluhaolithreeday_AwardInfo", 1)
	     -- 播放特效
		 local effects = {}
		 local effect = {}
		 effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
		 effect.id = FCActivityConf.denglulibao[2]
		 effect.count = 1
		 effects[#effects+1] = effect
		 if #effects > 0 then
			MiscFunc.PlayItemEffect(sysarg, 1, effects)
		 end
	     st.dengluhaoliInfo.five = 2
	  elseif st.dengluhaoliInfo.seven == 1 then
	     if Item.getBagEmptyGridCount(sysarg) < 1 then
		    LActor.sendTipmsg(sysarg, Lang.PetLang.p33, ttMessage)
		    return
	     end
	      LActor.addItem(sysarg, FCActivityConf.denglulibao[3], 0,0,1,1, "denglufiveday_AwardInfo", 1)
	      -- 播放特效
		 local effects = {}
		 local effect = {}
		 effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
		 effect.id = FCActivityConf.denglulibao[3]
		 effect.count = 1
		 effects[#effects+1] = effect
		 if #effects > 0 then
			MiscFunc.PlayItemEffect(sysarg, 1, effects)
		 end
	      st.dengluhaoliInfo.seven = 2
      end
    end

 	if st.dengluhaoliInfo.twoday == 1 or st.dengluhaoliInfo.five == 1 or st.dengluhaoliInfo.seven == 1 then
		haolistatu = 1
    elseif st.dengluhaoliInfo.twoday == 2 and st.dengluhaoliInfo.five == 2 and st.dengluhaoliInfo.seven == 2 then
    	haolistatu = 2
    else
    	haolistatu = 0
    end

    local pack = DataPack.allocPacket(sysarg, 200, 15)
    if pack == nil then return end
    DataPack.writeInt(pack,haolistatu)
    DataPack.flush(pack)
end
--获取登录好礼累计登录的奖励 for wupeng add 2013-10-29 end

FCActivityHandler.LoginList = function (flag)
   local  nooff = FCActivityHandler.sendnooffInfo()
   if nooff ~= 1 then return end
   local systemst = System.getDyanmicVar()
   local day = System.getOpenServerDay()
    --活动开启第一天获取1种A类产品 for wupeng add 2013-10-28 begin
   if systemst.AwardInfo == nil then
    systemst.AwardInfo = {}
    for i=1, 9 do
      systemst.AwardInfo[i] = 0
    end   
    --活动开启每天获取8种B类产品 for wupeng add 2013-10-28 end
   end
    if day == 8 then
       systemst.AwardInfo[1] = FCActivityConf.ABAward.AAwardPos[System.getRandomNumber(#FCActivityConf.ABAward.AAwardPos)+1].itemid
    end
    if flag ~= 0 then
       systemst.AwardInfo[1] = FCActivityConf.ABAward.AAwardPos[System.getRandomNumber(#FCActivityConf.ABAward.AAwardPos)+1].itemid
    end
     --活动开启第一天获取1种A类产品 for wupeng add 2013-10-28 end
  
     --活动开启每天获取8种B类产品 for wupeng add 2013-10-28 begin

    local Temporary2 = 0
    local irand = 0
    for i =2, 9 do    
    	for x=1,100 do
	        Temporary2 = FCActivityConf.ABAward.BAwardPos[System.getRandomNumber(#FCActivityConf.ABAward.BAwardPos)+1].itemid
	        local flag = 1
	        for j =2, #systemst.AwardInfo do
	        	if systemst.AwardInfo[j] ~= 0 and systemst.AwardInfo[j] == Temporary2 then
	        		flag = 0
	        		break
	        	end
	        end
	        if flag == 1 then
	        	systemst.AwardInfo[i] = Temporary2
	        	break
	        end
    	end	
    	if systemst.AwardInfo[i] == 0 then
    		systemst.AwardInfo[i] = FCActivityConf.ABAward.BAwardPos[System.getRandomNumber(#FCActivityConf.ABAward.BAwardPos)+1].itemid
    	end
    end
end 

--初始化
FCActivityHandler.dengluhaoliInit = function(sysarg)
    local  nooff = FCActivityHandler.sendnooffInfo()
    local systemst = System.getDyanmicVar()    
	if systemst.AwardInfo == nil then
        systemst.AwardInfo = {}
        for i = 1,9 do
             systemst.AwardInfo[i] = 0
	    end 
    end

    local st = LActor.getStaticVar(sysarg)
	if st == nil then return end

    if nooff == 1 then

	    if st.EveDayInfo == nil then
		   st.EveDayInfo = {}
		   st.EveDayInfo.countnumber = 0
		   st.EveDayInfo.zongci = 0
		   st.EveDayInfo.number = 0	
		   st.EveDayInfo.LActornumber = 0
		   st.EveDayInfo.time = System.getToday()	
		   st.EveDayInfo.fapai = {} 
		   st.EveDayInfo.biaoshi = {}
		   for i = 1,9 do
	         st.EveDayInfo.fapai[i] = 0
	         st.EveDayInfo.biaoshi[i] = 0         
		    end                                                   	   
		end
		--用来标志当天玩家抽掉牌的标识，每天必须重置为0，被抽为1，没被抽为0
		for x=1,9 do
            st.EveDayInfo.biaoshi[x] = 0
		end
		if System.getToday() - st.EveDayInfo.time <= 86400  then
	       st.EveDayInfo.number = st.EveDayInfo.number + 1
	       st.EveDayInfo.countnumber = st.EveDayInfo.countnumber + 1
	       st.EveDayInfo.zongci = st.EveDayInfo.zongci + 1
	    else
	       st.EveDayInfo.number = 1
	       st.EveDayInfo.countnumber = 1
	       st.EveDayInfo.zongci = st.EveDayInfo.zongci + 1
	    end
	    if st.EveDayInfo.countnumber > 3 then
	       st.EveDayInfo.number = 3
	    end
	      st.EveDayInfo.time = System.getToday()
	      st.EveDayInfo.LActornumber = st.EveDayInfo.number
	    for i = 1,9 do
	      st.EveDayInfo.fapai[i] = systemst.AwardInfo[i]
		end

		 if st.dengluhaoliInfo == nil then
		    st.dengluhaoliInfo  = {}
		    st.dengluhaoliInfo.twoday = 0
		    st.dengluhaoliInfo.five = 0
		    st.dengluhaoliInfo.seven = 0
		end

		--根据玩家登录次数设置第几天的奖励为可以领取状态 for wupeng 2013-10-30 begin
		if st.EveDayInfo.zongci == 2 and st.dengluhaoliInfo.twoday == 0 then
		   st.dengluhaoliInfo.twoday = 1
		end
		if st.EveDayInfo.zongci == 3 and st.dengluhaoliInfo.five == 0 then
		   st.dengluhaoliInfo.five = 1
		end
		if st.EveDayInfo.zongci == 5 and st.dengluhaoliInfo.seven == 0 then
			st.dengluhaoliInfo.seven =1
		end
	else
		if st.dengluhaoliInfo == nil then
			return
		end
		if st.dengluhaoliInfo.twoday == 1 then
			System.sendGmMailOffLine(LActor.getActorId(sysarg), "活动已结束，未领取的奖励以邮件的形式发送至您的邮箱，请提取附件奖励", 1, FCActivityConf.denglulibao[1], 1, 1);
			st.dengluhaoliInfo.twoday = 2
		end
		if st.dengluhaoliInfo.five == 1 then
			System.sendGmMailOffLine(LActor.getActorId(sysarg), "活动已结束，未领取的奖励以邮件的形式发送至您的邮箱，请提取附件奖励", 1, FCActivityConf.denglulibao[2], 1, 1);
			st.dengluhaoliInfo.five = 2
		end
		if st.dengluhaoliInfo.seven == 1 then
			System.sendGmMailOffLine(LActor.getActorId(sysarg), "活动已结束，未领取的奖励以邮件的形式发送至您的邮箱，请提取附件奖励", 1, FCActivityConf.denglulibao[3], 1, 1);
			st.dengluhaoliInfo.seven = 2
		end
    end
end

--幸运猜猜
FCActivityHandler[17] = function ( sysarg, dp )
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
    if st.GuessInfo == nil then
	   st.GuessInfo = {}
	   st.GuessInfo.total = 0
	   st.GuessInfo.used = 0
	   st.GuessInfo.time = System.getToday()	
	   st.GuessInfo.CupInfo = {}
	   for i=1,3 do
	   		st.GuessInfo.CupInfo[i] = {}
	   		st.GuessInfo.CupInfo[i].id = 0
	   end                                                  	   
	end 
    
    local pack = DataPack.allocPacket(sysarg, 200, 17)
    if pack == nil then return end
    local left = st.GuessInfo.total - st.GuessInfo.used 
    if left < 0 then
    	left = 0
    end
    DataPack.writeInt(pack, left)
    DataPack.flush(pack)
end

FCActivityHandler[18] = function ( sysarg, dp )
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end

    local systemst = System.getDyanmicVar()
	if systemst.GuessInfo == nil then
        systemst.GuessInfo = {}
        for i=1,3 do
        	systemst.GuessInfo[i] = 1
        end
    end
    
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
    if st.GuessInfo == nil then
	   st.GuessInfo = {}
	   st.GuessInfo.total = 0
	   st.GuessInfo.used = 0
	   st.GuessInfo.time = System.getToday()	
	   st.GuessInfo.CupInfo = {}
	   for i=1,3 do
	   		st.GuessInfo.CupInfo[i] = {}
	   		st.GuessInfo.CupInfo[i].id = 0
	   end                                                  	   
	end 

   
    for i=1,3 do
    	st.GuessInfo.CupInfo[i].id = FCActivityConf.GuessAward[systemst.GuessInfo[i]].itemid
    end
    
    local pack = DataPack.allocPacket(sysarg, 200, 18)
    if pack == nil then return end
    local count = #st.GuessInfo.CupInfo
    DataPack.writeInt(pack,count)
    for i = 1,count do
       DataPack.writeInt(pack, st.GuessInfo.CupInfo[i].id)
    end    

    DataPack.flush(pack)
end

FCActivityHandler[19] = function ( sysarg, dp )
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
    if st.GuessInfo == nil then
	   st.GuessInfo = {}
	   st.GuessInfo.total = 0
	   st.GuessInfo.used = 0
	   st.GuessInfo.time = System.getToday()	
	   st.GuessInfo.CupInfo = {}
	   for i=1,3 do
	   		st.GuessInfo.CupInfo[i] = {}
	   		st.GuessInfo.CupInfo[i].id = 0
	   end                                                  	   
	end 
    
    local left = st.GuessInfo.total - st.GuessInfo.used 
    if left <= 0 then
    	LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc006, ttMessage)
    	return
    end

    local  cup = {}
	for i=1,3 do
		cup[i] = {}
		cup[i].id = st.GuessInfo.CupInfo[i].id 
	end

	local tmp = {1,2,3}
	local temp = {}
	local first = System.getRandomNumber(3)+1
	local n = 1
	for i=1,3 do
		if tmp[i] ~= first then
			temp[n] = tmp[i]
			n = n + 1
		end
	end
	local second = temp[System.getRandomNumber(2)+1]
	local third = 0
	for i=1,#temp do
		if temp[i] ~= second then
			third = temp[i]
			break
		end
	end

	st.GuessInfo.CupInfo[1].id = cup[first].id
	st.GuessInfo.CupInfo[2].id = cup[second].id
	st.GuessInfo.CupInfo[3].id = cup[third].id

    local pack = DataPack.allocPacket(sysarg, 200, 19)
    if pack == nil then return end
    local count = #st.GuessInfo.CupInfo
    DataPack.writeInt(pack,count)
    for i = 1,count do
       DataPack.writeInt(pack, st.GuessInfo.CupInfo[i].id)
    end    

    DataPack.flush(pack)
end

FCActivityHandler[20] = function ( sysarg, dp )
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
    if st.GuessInfo == nil then
	   st.GuessInfo = {}
	   st.GuessInfo.total = 0
	   st.GuessInfo.used = 0
	   st.GuessInfo.time = System.getToday()	
	   st.GuessInfo.CupInfo = {}
	   for i=1,3 do
	   		st.GuessInfo.CupInfo[i] = {}
	   		st.GuessInfo.CupInfo[i].id = 0
	   end                                                  	   
	end 

    local systemst = System.getDyanmicVar()
	if systemst.GuessInfo == nil then
        systemst.GuessInfo = {}
        for i=1,3 do
        	systemst.GuessInfo[i] = 1
        end
    end
    
	local ty = DataPack.readInt(dp)
	if ty < 1 or ty > 3 then
		LActor.sendTipmsg(sysarg, Lang.ScriptTips.fc007, ttMessage)
		return
	end

	local count = 1 
	for i=1,#FCActivityConf.GuessAward do
		if FCActivityConf.GuessAward[i].itemid == st.GuessInfo.CupInfo[ty].id then
			count = FCActivityConf.GuessAward[i].count
			break
		end
	end

	if LActor.addItem(sysarg, st.GuessInfo.CupInfo[ty].id, 0, 0, count, 1, "guess_award", 1) >= 1 then
		-- 播放特效
	   	local effects = {}
		local effect = {}
		effect.type = 1  -- 1为物品,暂时只支持发物品所以写死
	    effect.id = st.GuessInfo.CupInfo[ty].id
	    effect.count = 1
	    effects[#effects+1] = effect
		if #effects > 0 then
			MiscFunc.PlayItemEffect(sysarg, 1, effects)
		end
	else
		System.sendGmMailOffLine(LActor.getActorId(sysarg), "您的背包已满，奖励以邮件的形式发送至您的邮箱，请提取附件奖励", 1, st.GuessInfo.CupInfo[ty].id, count, 1);
	end

    st.GuessInfo.used = st.GuessInfo.used + 1
    local pack = DataPack.allocPacket(sysarg, 200, 20)
    if pack == nil then return end
    DataPack.writeInt(pack, st.GuessInfo.CupInfo[ty].id)
    DataPack.flush(pack)
end

FCActivityHandler.GuessIsOPen = function()
    local day = System.getOpenServerDay();
    local nooff = 0;
    --开服第三周开启活动
    if day >= 15 and day <= 21 then
    	nooff = 1;
    end
    return nooff
end   

--幸运猜猜活动开启和关闭  
FCActivityHandler.notifyGuessOpen = function (sysarg)
    local  nooff = FCActivityHandler.GuessIsOPen()

    local pack = DataPack.allocPacket(sysarg, 200, 16)
    if pack == nil then return end
	DataPack.writeInt(pack, nooff)
	DataPack.flush(pack)
end

FCActivityHandler.GuessSysUpdate = function ()
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end
    local systemst = System.getDyanmicVar()
	if systemst.GuessInfo == nil then
        systemst.GuessInfo = {}
        for i=1,3 do
        	systemst.GuessInfo[i] = 1
        end
    end
	
    systemst.GuessInfo[1] = System.getRandomNumber(#FCActivityConf.GuessAward)+1
    for i=1,100 do
    	systemst.GuessInfo[2] = System.getRandomNumber(#FCActivityConf.GuessAward)+1
    	if systemst.GuessInfo[2] ~= systemst.GuessInfo[1] then
    		break
    	end
    end
    for i=1,100 do
    	systemst.GuessInfo[3] = System.getRandomNumber(#FCActivityConf.GuessAward)+1
    	if systemst.GuessInfo[3] ~= systemst.GuessInfo[1] and systemst.GuessInfo[3] ~= systemst.GuessInfo[2] then
    		break
    	end
    end
end

FCActivityHandler.GuessActorUpdate = function (sysarg)
	local  nooff = FCActivityHandler.GuessIsOPen()
	if nooff ~= 1 then return end
    local systemst = System.getDyanmicVar()
	if systemst.GuessInfo == nil then
        systemst.GuessInfo = {}
        for i=1,3 do
        	systemst.GuessInfo[i] = 1
        end
    end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
    if st.GuessInfo == nil then
	   st.GuessInfo = {}
	   st.GuessInfo.total = 0
	   st.GuessInfo.used = 0
	   st.GuessInfo.time = System.getToday()	
	   st.GuessInfo.CupInfo = {}
	   for i=1,3 do
	   		st.GuessInfo.CupInfo[i] = {}
	   		st.GuessInfo.CupInfo[i].id = 0
	   end                                                  	   
	end 
	if System.getToday() - st.GuessInfo.time <= 86400  then
       st.GuessInfo.total = st.GuessInfo.total + 1
    else
       st.GuessInfo.total = 1
    end
    if st.GuessInfo.total > 3 then
       st.GuessInfo.total = 3
    end
    st.GuessInfo.used = 0
    st.GuessInfo.time = System.getToday()
end

FCActivityHandler.OnTime = function ( )
	if FCActivityHandler.IsOpen() == 0 then return end
	local hour = 0
	local min = 0
	local sec = 0

	hour,min,sec= System.getTime(hour,min,sec) 

	if hour == FCActivityConf.onlineRewardTime[1].endHour and min == FCActivityConf.onlineRewardTime[1].endMin then
		FCActivityHandler.NotifyActor(1, 0)
	end

	if hour == FCActivityConf.onlineRewardTime[2].startHour and min == FCActivityConf.onlineRewardTime[2].startMin then
		FCActivityHandler.NotifyActor(2, 1)
	end

	if hour == FCActivityConf.onlineRewardTime[2].endHour and min == FCActivityConf.onlineRewardTime[2].endMin then
		FCActivityHandler.NotifyActor(2, 0)
	end

	if hour == FCActivityConf.onlineRewardTime[1].startHour and min == FCActivityConf.onlineRewardTime[1].startMin then
		FCActivityHandler.NotifyActor(1, 1)
	end
end

FCActivityHandler.OnActorLogin = function ( sysarg )
	FCActivityHandler.sendSeveAwardInfo(sysarg)
	--判断 登录好礼活动开启和关闭 wupeng add 2013-10-28 begin
	FCActivityHandler.sendLoginAwardInfo(sysarg)
	--判断 登录好礼活动开启和关闭 wupeng add 2013-10-28 end
	--幸运猜猜
	FCActivityHandler.notifyGuessOpen(sysarg)

	if FCActivityHandler.IsOpen() == 0 then return end	
	FCActivityHandler.StartFC(sysarg)
	FCActivityHandler.ActivityReward (sysarg)
	FCActivityHandler.NotifyOnlineReward(sysarg)
	FCActivityHandler.SendKeepTimeInfo(sysarg)
	FCActivityHandler.sendJuniorEffort(sysarg)
end

FCActivityHandler.ResetActivityAward = function ( sysarg )
	if FCActivityHandler.IsOpen() == 0 then return end

	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
		
	if st.fcreward.activityaward == nil then
		st.fcreward.activityaward = {}
	end
	for i = 1, #FCActivityConf.activity do
 		st.fcreward.activityaward[i] = 0
 	end
end

FCActivityHandler.ResetKeepTime = function ( sysarg )
	if FCActivityHandler.IsOpen() == 0 then return end
	
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end

	if st.fcreward.keeploginaward  == nil then
 		st.fcreward.keeploginaward = {}
 	end
	for i = 1, #FCActivityConf.keeptime do
		st.fcreward.keeploginaward[i] = 0
	end
end

FCActivityHandler.OnNewDayArrive = function ( sysarg )
	FCActivityHandler.sendSeveAwardNewDay(sysarg)
	--判断 玩家一直没下线过了0点后，登录好礼活动开启和关闭 wupeng add 2013-10-28 begin
	FCActivityHandler.sendLoginAwardInfo(sysarg)
	--判断 玩家一直没下线过了0点后，登录好礼活动开启和关闭 wupeng add 2013-10-28 end
	FCActivityHandler.dengluhaoliInit(sysarg)
	--幸运猜猜
	FCActivityHandler.notifyGuessOpen(sysarg)
	FCActivityHandler.GuessActorUpdate(sysarg)

	if FCActivityHandler.IsOpen() == 0 then return end
	FCActivityHandler.ResetOnlineReward(sysarg)
	FCActivityHandler.DailyReward(sysarg)
	FCActivityHandler.ResetActivityAward(sysarg)
	FCActivityHandler.ResetKeepTime(sysarg)
end

FCActivityHandler.ResetOnlineReward = function ( sysarg )
	local st = FCActivityHandler.GetFCActivityData(sysarg)
	if st == nil then return end
 	st.fcreward.onlinereward1 = 0
 	st.fcreward.onlinereward2 = 0
end

FCActivityHandler.OnActorLevelUp = function ( sysarg, args )
	local st = FCActivityHandler.GetFCActivityData(sysarg)
 	if st == nil then return end
	local newLevel = args[1]
	for i = 1, #FCActivityConf.uplevel do
		if newLevel == FCActivityConf.uplevel[i] then
			st.fcreward.levelupreward[i] = 1
			local pack = DataPack.allocPacket(sysarg, 200, 1)
			if pack == nil then return end
			local count = #st.fcreward.levelupreward
			DataPack.writeInt(pack, count)
			for j = 1, count do
				DataPack.writeInt(pack, FCActivityConf.uplevel[i])
				DataPack.writeInt(pack, st.fcreward.levelupreward[i])
			end
			DataPack.flush(pack)
			return
		end
	end
end

FCActivityHandler.main = function ( sysarg, sysitemid, msgid, packet )
	if FCActivityHandler[msgid] ~= nil then
		FCActivityHandler[msgid](sysarg, packet)
	end
end

--table.insert(TimeFnTable, FCActivityHandler.OnTime)

--SystemHandlerDispatcher.registerSystemHander(200, FCActivityHandler.main)

--EventCallDispatcher.registerEventCall(BaseTypes.ActorEventId.aeUserLogin, FCActivityHandler.OnActorLogin)
--EventCallDispatcher.registerEventCall(BaseTypes.ActorEventId.aeNewDayArrive, FCActivityHandler.OnNewDayArrive)
--EventCallDispatcher.registerEventCall(BaseTypes.ActorEventId.aeLevel, FCActivityHandler.OnActorLevelUp)

FCActivityHandler.AddGuestNum = function ( sysarg , args)
  if args[1] == nil then return false end

  local num = tonumber(args[1])

  local st = LActor.getStaticVar(sysarg)
  if st == nil then return end
  st.GuessInfo.total = st.GuessInfo.total + num
end

--抽奖次数 for wupeng add 2013-10-30
FCActivityHandler.AddLActornumber = function ( sysarg, args )
	if args[1] == nil then return false end
	local number = tonumber(args[1])
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	st.EveDayInfo.LActornumber = st.EveDayInfo.LActornumber + number
end

--礼包次数 for wupeng add 2013-10-30
FCActivityHandler.addlibao = function (sysarg, args)
    if args[1] == nil then return false end
	local number = tonumber(args[1])
	local st = LActor.getStaticVar(sysarg)
	if st == nil then return end
	st.EveDayInfo.zongci = st.EveDayInfo.zongci + number
end

GmEventFuncList.register("openfc", FCActivityHandler.Open, 1)
GmEventFuncList.register("closefc", FCActivityHandler.Close, 1)
GmEventFuncList.register("clearfcdata", FCActivityHandler.ClearActorData, 1)
GmEventFuncList.register("addguessnum", FCActivityHandler.AddGuestNum, 1)
GmEventFuncList.register("addnum",FCActivityHandler.AddLActornumber, 1)
GmEventFuncList.register("addlibao",FCActivityHandler.addlibao, 1)

function FCPerDay()
    FCActivityHandler.LoginList(0)
    FCActivityHandler.GuessSysUpdate()
end